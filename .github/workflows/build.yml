name: Swift Vapor CI/CD

on:
  push:
    branches:
      - main  # 更改为你的默认分支，例如master或main

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up swiftenv
      run: git clone https://github.com/kylef/swiftenv.git ~/.swiftenv

    - name: Setup environment
      run: |
        export SWIFTENV_ROOT="$HOME/.swiftenv"
        export PATH="$SWIFTENV_ROOT/bin:$PATH"
        eval "$(swiftenv init -)"
        echo "$PATH" >> $GITHUB_PATH
        echo $SWIFTENV_ROOT

    - name: Setup tools
      run: |
        export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true \
        apt-get -q update \
        apt-get -q dist-upgrade -y\
        rm -rf /var/lib/apt/lists/*

    - name: Install Swift
      run: |
        swiftenv install 5.8.1 --skip-existing
        swiftenv global 5.8.1

    - name: Build Swift Project 
      run: |
        swift build -c release --static-swift-stdlib --show-bin-path

    - name: Archive Build Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: vapor-app-artifact
        path: |
          .build
          Public
          Resources

