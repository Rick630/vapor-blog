## Vapor 博客系统实战项目

开发状态：开发中...

页面预览：[页面预览](https://github.com/swiftdo/vapor-blog/wiki/%E9%A1%B5%E9%9D%A2%E9%A2%84%E8%A7%88)

源码：

[https://github.com/swiftdo/vapor-blog](https://github.com/swiftdo/vapor-blog)

网站：

![前端](https://github.com/swiftdo/vapor-blog/assets/12316547/c1df733b-5469-47c8-b213-b51d81130003)

后台：

![后台](https://github.com/swiftdo/vapor-blog/assets/12316547/2e5b6653-c7f9-4c05-bf56-616b382e56d6)

文档：

相关文档：[点击前往](https://github.com/swiftdo/vapor-blog/wiki)

## 角色和权限：

系统管理员 > 管理员 > 其他.

系统管理员：是指内置的一个管理员，它无视权限校验，全部功能都可用，只能操作数据库的字段才能指定。
管理员：有管理权限 + 用户自身权限
普通用户：用户自身权限
其他：...

所以系统必须至少内置一个系统管理员，以及初始化一个普通用户角色。

## TODO

* [ ] 文章评论、收藏、点赞
* [ ] 文章统计
* [ ] 个人消息中心
* [ ] 后台主页
    * 博客数量
    * 今日发表
    * 今日访客
    * 历史访客
    * 网站访问人数
* [ ] 操作日志
* [ ] 留言功能
* [ ] 消息/通知中心
* [ ] 个人中心
* [ ] 个人主页
* [ ] 关注

## 通用的评论设计

一个文章下面可以有评论，其他人可以对评论进行回复，还可以对回复进行回复。但是对回复的回复一般无论回复多少层，都是并列显示的，只不过引用被回复的内容。

这种结构不完全是树形结构，基本上只有上下两级，一级评论，二级回复。

### 评论表设计

| 表字段 | 说明 |
| --- | --- |
| id | 主键 |
| topic_id | 主题id |
| topic_type | 主题类型 |
| content | 评论内容 |
| from_uid | 评论用户id |
| created_time | 创建时间 |
| updated_time | 更新时间 |

### 回复表设计

| 表字段 | 说明 |
| --- | --- |
| id | 主键 |
| comment_id | 评论id |
| reply_id | 回复目标id |
| reply_type | 回复目标类型 |
| content | 回复内容 |
| from_uid | 回复用户id |
| to_uid | 目标用户id |
| created_time | 创建时间 |
| updated_time | 更新时间 |

​comment_id​​字段来表示该回复挂在的根评论id，我们可以直接通过评论id一次性的捞出该评论下的所有回复。

`reply_type`​​表示回复的类型，因为回复可以是针对评论的回复(comment)，也可以是针对回复的回复(reply)， 通过这个字段来区分两种情景。

​`​reply_id`​​表示回复目标的id，如果`reply_type`是comment的话，那么reply_id＝commit_id，如果reply_type是reply的话，这表示这条回复的父回复。

## 通知设计

通知包括：
1) 点对点的通知，例如点赞，评论等；
2) 点对面的通知，系统管理员对系统内的部分或者全部用户发送通知公告。

数据库设计包含两张表，一张存储消息发送记录表，另外一张存放具体的消息内容。



### 通知发送记录表

| 表字段 | 说明 |
| --- | --- |
| id | 主键 |
| sender_id | 发送者id |
| receiver_id | 接收者id |
| msg_info_id | 通知详细内容id |
| status | 查看状态：1已查看，0未查看 |
| created_time | 创建时间 |
| updated_time | 更新时间 |

### 通知

| 表字段 | 说明 |
| --- | --- |
| id | 主键 |
| target_id | 消息对象id，例如文章id |
| title | 消息标题 |
| content | 消息内容 |
| msg_type | 消息类型：1评论，2回复评论，3关注，4喜欢，5系统通知 |
| created_time | 创建时间 |
| updated_time | 更新时间 |

### 场景

点对点的通知：

张三点赞了李四的“关于站内通知系统的设计与实现”这篇文章；这样的一条通知，由张三发起，李四接收，消息类型是 点赞，消息目标对象 target_id 是  “关于站内通知系统的设计” 这篇文章的ID，title 可以设置成文章名称，也可以设置为null，程序实现的时候可以通过ID获取到文章的相关信息，content 就可以写成举例的这个通知内容。

点对面的通知：

管理员发送通知给站内的所有用户或者部分用户，这里的用户筛选，需要在程序里面进行，数据库只记录发送给了谁。例如：管理员给站内年级大于30岁的用户发送早起跑步活动通知，那么首先根据年纪大于30这个搜索条件找到所有年纪大于30岁的用户，然后再批量向数据库中插入这些记录，target_id为活动的ID，title 为活动通知，当然也可以为空，可以选择把将这个title的内容放在content里面，具体情况具体对待，content为早起锻炼活动，然后用户接收到这条通知之后，可以根据 target_id 找到具体活动详情。

### 给某一用户发送点赞通知：

这个需要向两个表里面插入数据，在message表里面插入通知记录，在message_info表里面插入具体的消息内容。需要使用数据库事务这个操作，避免数据不一致性

### 给所有用户发送系统通知

这个通知的发送，和上面一样，不同点就是需要先获取那些到用户ID，然后批量插入，也是插入两张表

























